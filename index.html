<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Izin Pro | Sistem Struk Izin Sekolah</title>
    <!-- Tailwind CSS & Lucide Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }

        /* Desain Struk Thermal */
        #thermal-receipt {
            font-family: 'Courier New', Courier, monospace;
            width: 300px;
            min-height: 480px;
            background: white;
            padding: 25px;
            position: relative;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-top: 10px solid #0f172a;
            overflow: hidden;
        }

        .watermark {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.04;
            pointer-events: none;
            transform: rotate(-35deg);
            font-size: 2.8rem;
            font-weight: 900;
            text-align: center;
            z-index: 0;
        }

        .receipt-edge {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background-image: linear-gradient(135deg, #f1f5f9 25%, transparent 25%), 
                              linear-gradient(225deg, #f1f5f9 25%, transparent 25%);
            background-position: 0 0;
            background-size: 20px 20px;
        }

        @media print {
            body { background: white !important; }
            #ui-panel { display: none !important; }
            #receipt-container { 
                padding: 0 !important; 
                margin: 0 !important;
                display: block !important;
            }
            #thermal-receipt {
                box-shadow: none !important;
                border: none !important;
                width: 58mm !important;
                margin: 0 !important;
                padding: 5mm !important;
            }
        }
    </style>
</head>
<body class="pb-12">

    <!-- Navbar -->
    <nav id="ui-panel" class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="shield-check" class="text-emerald-400"></i>
                <h1 class="font-bold text-lg tracking-wider">E-IZIN PRO</h1>
            </div>
            <div class="flex items-center gap-3 bg-slate-800 px-3 py-1 rounded-full border border-slate-700">
                <div id="bt-dot" class="h-2 w-2 rounded-full bg-rose-500"></div>
                <span class="text-[10px] font-bold uppercase tracking-widest opacity-80" id="bt-text">Printer Disconnected</span>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto p-4 md:p-10 grid grid-cols-1 lg:grid-cols-2 gap-10">
        
        <!-- INPUT SECTION -->
        <section id="ui-panel" class="space-y-6">
            <!-- Settings Card -->
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200">
                <div class="flex items-center gap-2 mb-5 text-slate-400">
                    <i data-lucide="settings-2" size="18"></i>
                    <h2 class="text-xs font-bold uppercase tracking-widest">Pengaturan Instansi</h2>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">NAMA SEKOLAH</label>
                        <div class="relative">
                            <i data-lucide="school" class="absolute left-3 top-2.5 text-slate-400" size="16"></i>
                            <input type="text" id="in-school" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 mb-1 block">ADMIN / DEVELOPER</label>
                        <div class="relative">
                            <i data-lucide="user-check" class="absolute left-3 top-2.5 text-slate-400" size="16"></i>
                            <input type="text" id="in-dev" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-10 pr-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Data Card -->
            <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-5">
                    <div class="flex items-center gap-2 text-slate-400">
                        <i data-lucide="clipboard-list" size="18"></i>
                        <h2 class="text-xs font-bold uppercase tracking-widest">Detail Izin</h2>
                    </div>
                    <button id="btn-reset" class="text-rose-500 hover:bg-rose-50 px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-2 transition-all">
                        <i data-lucide="rotate-ccw" size="14"></i> RESET
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="relative">
                        <input type="text" id="in-name1" placeholder="Nama Siswa 1..." class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-inner">
                    </div>
                    <div class="relative">
                        <input type="text" id="in-name2" placeholder="Nama Siswa 2 (Opsional)..." class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none shadow-inner">
                    </div>
                    <textarea id="in-reason" placeholder="Keperluan / Alasan..." class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none h-28 resize-none shadow-inner"></textarea>
                </div>

                <div class="mt-8 flex flex-col gap-3">
                    <button id="btn-bluetooth" class="flex items-center justify-center gap-3 py-4 bg-blue-600 text-white rounded-2xl font-bold hover:bg-blue-700 transition-all active:scale-[0.97] shadow-lg shadow-blue-100">
                        <i data-lucide="bluetooth" size="20"></i> HUBUNGKAN PRINTER
                    </button>
                    <button id="btn-print" class="flex items-center justify-center gap-3 py-5 bg-slate-900 text-white rounded-2xl font-bold hover:bg-black transition-all active:scale-[0.97] shadow-xl shadow-slate-200">
                        <i data-lucide="printer" size="20"></i> CETAK STRUK SEKARANG
                    </button>
                </div>
            </div>
        </section>

        <!-- RECEIPT PREVIEW SECTION -->
        <section id="receipt-container" class="flex flex-col items-center">
            <div class="mb-5 text-slate-400 font-bold uppercase tracking-[0.3em] text-[10px] flex items-center gap-3">
                <span class="h-[1px] w-12 bg-slate-200"></span>
                Receipt Preview
                <span class="h-[1px] w-12 bg-slate-200"></span>
            </div>

            <div id="thermal-receipt">
                <!-- Watermark Layer -->
                <div class="watermark" id="view-watermark">IZIN SAH</div>
                
                <div class="relative z-10 text-black">
                    <!-- Receipt Header -->
                    <div class="text-center mb-5">
                        <h3 id="view-school" class="font-bold text-[13px] uppercase underline leading-tight tracking-tight">NAMA SEKOLAH ANDA</h3>
                        <p class="text-[10px] mt-1 font-bold">SURAT IZIN KELUAR</p>
                        <p class="text-[10px] opacity-40">----------------------------</p>
                    </div>

                    <!-- Meta Data -->
                    <div class="text-[10px] space-y-1 mb-5">
                        <div class="flex justify-between">
                            <span>TANGGAL : <span id="view-date">--/--/--</span></span>
                        </div>
                        <div class="flex justify-between">
                            <span>WAKTU   : <span id="view-time">00:00</span></span>
                        </div>
                        <div class="flex justify-between font-bold mt-1">
                            <span>VERIFIKASI:</span>
                            <span>VALID DIGITAL</span>
                        </div>
                    </div>

                    <div style="border-top: 1px dashed #000; margin: 10px 0;"></div>

                    <!-- Student & Reason -->
                    <div class="text-[10px] space-y-4">
                        <div>
                            <span class="font-bold underline">DAFTAR SISWA:</span>
                            <div class="mt-2 pl-1 flex gap-2">
                                <span>1.</span>
                                <span id="view-name1" class="font-bold">____________________</span>
                            </div>
                            <div class="mt-1 pl-1 flex gap-2" id="view-row-name2">
                                <span>2.</span>
                                <span id="view-name2" class="font-bold">____________________</span>
                            </div>
                        </div>
                        <div>
                            <span class="font-bold underline uppercase">Alasan Keluar:</span>
                            <p id="view-reason" class="mt-2 pl-1 italic leading-relaxed text-[10px]">
                                Menunggu input data...
                            </p>
                        </div>
                    </div>

                    <div style="border-top: 1px dashed #000; margin: 25px 0 5px 0;"></div>

                    <!-- Single Signature Section -->
                    <div class="mt-6 flex flex-col items-end text-[10px]">
                        <div class="text-center w-32">
                            Guru Piket,<br><br><br><br><br>
                            ( ................ )
                        </div>
                    </div>

                    <!-- Footer Section -->
                    <div class="mt-12 flex flex-col items-center gap-3">
                        <!-- QR Simulation -->
                        <div id="qr-box" class="w-16 h-16 border border-black p-1 flex flex-wrap opacity-90 bg-white">
                        </div>
                        <p class="text-[9px] font-bold tracking-tighter uppercase">Verifikasi Keaslian Sistem</p>
                        <div class="text-[7px] mt-6 opacity-40 text-center uppercase leading-tight">
                            Powered by E-Izin Pro<br>
                            Sistem Oleh: <span id="view-dev" class="font-bold">Developer</span>
                        </div>
                    </div>
                </div>

                <div class="receipt-edge"></div>
            </div>

            <div class="mt-8 bg-emerald-50 text-emerald-600 px-5 py-2.5 rounded-full text-xs font-bold border border-emerald-100 flex items-center gap-2 animate-pulse no-print">
                <i data-lucide="check-circle-2" size="16"></i> Sistem Siap Cetak
            </div>
        </section>
    </main>

    <script>
        // DOM Elements
        const inputs = {
            school: document.getElementById('in-school'),
            dev: document.getElementById('in-dev'),
            name1: document.getElementById('in-name1'),
            name2: document.getElementById('in-name2'),
            reason: document.getElementById('in-reason')
        };

        const views = {
            school: document.getElementById('view-school'),
            dev: document.getElementById('view-dev'),
            name1: document.getElementById('view-name1'),
            name2: document.getElementById('view-name2'),
            rowName2: document.getElementById('view-row-name2'),
            reason: document.getElementById('view-reason'),
            date: document.getElementById('view-date'),
            time: document.getElementById('view-time'),
            watermark: document.getElementById('view-watermark'),
            qr: document.getElementById('qr-box'),
            btDot: document.getElementById('bt-dot'),
            btText: document.getElementById('bt-text')
        };

        // Initialize App
        function init() {
            // Load from LocalStorage
            inputs.school.value = localStorage.getItem('e_izin_school') || 'NAMA SEKOLAH ANDA';
            inputs.dev.value = localStorage.getItem('e_izin_dev') || 'NAMA ANDA';
            
            updatePreview();
            generateQR();
            lucide.createIcons();
        }

        // Live Update Function
        function updatePreview() {
            const now = new Date();
            
            views.school.innerText = inputs.school.value || 'NAMA SEKOLAH ANDA';
            views.dev.innerText = inputs.dev.value || 'Developer';
            views.name1.innerText = inputs.name1.value || '____________________';
            views.name2.innerText = inputs.name2.value || '____________________';
            views.reason.innerText = inputs.reason.value || 'Menunggu input data...';
            
            // Format Date & Time
            views.date.innerText = now.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
            views.time.innerText = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) + " WITA";
            
            // Sync Watermark
            const wm = `IZIN SAH\n${(inputs.dev.value || 'DEVELOPER').toUpperCase()}`;
            views.watermark.innerText = wm;

            // Visibility Logic for Student 2
            views.rowName2.style.display = inputs.name2.value ? 'flex' : 'none';

            // Save Persistence
            localStorage.setItem('e_izin_school', inputs.school.value);
            localStorage.setItem('e_izin_dev', inputs.dev.value);
        }

        // Generate Simulated QR
        function generateQR() {
            views.qr.innerHTML = '';
            for(let i=0; i<144; i++) {
                const dot = document.createElement('div');
                dot.style.width = '8.33%';
                dot.style.height = '8.33%';
                dot.style.backgroundColor = Math.random() > 0.45 ? 'black' : 'transparent';
                views.qr.appendChild(dot);
            }
        }

        // Bluetooth Simulation
        async function handleBluetooth() {
            try {
                // Mencari printer bluetooth (Hanya jalan di browser yang support & HTTPS)
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['000018f0-0000-1000-8000-00805f9b34fb'] }]
                });
                views.btDot.className = "h-2 w-2 rounded-full bg-emerald-500 animate-pulse";
                views.btText.innerText = "Printer Connected";
                alert("Berhasil terhubung ke Printer Thermal!");
            } catch (err) {
                alert("Koneksi Bluetooth dibatalkan atau tidak didukung pada browser ini.");
            }
        }

        // Event Listeners
        Object.values(inputs).forEach(el => {
            el.addEventListener('input', updatePreview);
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
            inputs.name1.value = '';
            inputs.name2.value = '';
            inputs.reason.value = '';
            updatePreview();
        });

        document.getElementById('btn-print').addEventListener('click', () => {
            if(!inputs.name1.value) {
                alert("Tolong isi minimal satu nama siswa!");
                return;
            }
            window.print();
        });

        document.getElementById('btn-bluetooth').addEventListener('click', handleBluetooth);

        // Run On Load
        window.onload = init;
    </script>
</body>
</html>

